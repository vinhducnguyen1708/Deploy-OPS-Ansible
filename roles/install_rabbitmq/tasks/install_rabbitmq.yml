---
- name: Install Rabbitmq-server.service
  yum:
    name: rabbitmq-server
  notify:
    - start rabbitmq-server.service

- name: start rabbitmq-server.service
  systemd:
     name: rabbitmq-server.service
     state: started
     enabled: yes 


- name: Copy script check
  copy:
   src: count_clustered_nodes.py
   dest: "{{ ansible_deploy_files }}/" 
   mode: '0777'


- name: check if clustered
  command: "python3 {{ ansible_deploy_files }}/count_clustered_nodes.py"
  register: nodes_count
  changed_when: False

- name: Set fact status rabbitmq cluster
  set_fact: 
      nodes_rabbitmq_count: "{{ nodes_count.stdout | int }}"

- include_tasks: config_rabbitmq.yml
  when: nodes_rabbitmq_count | int < groups['controller'] | length | int
